<body>
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
    }
    * {
      margin: 0;
    }
    html,
    body {
      height: 100%;
      font-family: "Roboto", sans-serif;
    }
    body {
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      padding: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      background-color: rgb(239, 239, 239);
    }
    input,
    button,
    textarea,
    select {
      font: inherit;
    }
    p,
    h1,
    h2,
    h3,
    h4,
    h5,
    h6 {
      overflow-wrap: break-word;
    }
    h1 {
      font-size: 1.5em;
      margin-bottom: 8px;
    }
    h2 {
      font-size: 1.25em;
    }
    input {
      width: 100%;
      min-height: 32px;
    }
    textarea {
      width: 100%;
      height: 100px;
    }
    .root {
      height: 500px;
      padding: 24px;
      border: 8px ridge;
      border-radius: 12px;
      background-color: white;
    }
    header {
      margin-bottom: 24px;
      padding-bottom: 24px;
      border-bottom: 1px dashed;
      display: flex;
      gap: 24px;
    }
    form {
      max-width: 200px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }
    .form-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .rules {
      display: flex;
      align-items: center;
      gap: 8px;
    }
  </style>

  <script
    crossorigin
    src="https://unpkg.com/react@17/umd/react.development.js"
  ></script>
  <script
    crossorigin
    src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"
  ></script>
  <script src="https://unpkg.com/react-hook-form@7.26.1/dist/index.umd.js"></script>
  <script src="https://unpkg.com/react-query/dist/react-query.production.min.js"></script>
  <script src="https://unpkg.com/react-query/dist/react-query-devtools.production.min.js"></script>
  <script src="https://unpkg.com/faker@5.5.3/dist/faker.min.js"></script>
  <link
    rel="stylesheet"
    href="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.64/dist/themes/light.css"
  />
  <script
    type="module"
    src="https://cdn.jsdelivr.net/npm/@shoelace-style/shoelace@2.0.0-beta.64/dist/shoelace.js"
  ></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <div data-js="root"></div>

  <script type="text/babel">
    const apiUrl = "https://620389084d21c200170b9e0f.mockapi.io/api";
    function client(
      endpoint,
      { data, headers: customHeaders, ...customConfig } = {}
    ) {
      return fetch(`${apiUrl}/${endpoint}`, {
        method: data ? "POST" : "GET",
        body: data ? JSON.stringify(data) : undefined,
        headers: {
          "Content-Type": data ? "application/json" : undefined,
          customHeaders,
        },
        ...customConfig,
      }).then((res) => res.json());
    }

    function useTodos() {
      return ReactQuery.useQuery(["todos"], () => client("todos"));
    }

    function useTodo(id) {
      return ReactQuery.useQuery(["todo", id], () => client(`todos/${id}`));
    }

    function useMutateTodo() {
      const queryClient = ReactQuery.useQueryClient();
      return ReactQuery.useMutation(
        (data) => client(`todos/${data.id}`, { method: "PUT", data }),
        {
          onSuccess: () => {
            queryClient.invalidateQueries(["todo", 1]);
          },
        }
      );
    }

    const FormGroup = (props) => {
      return <div className="form-group" {...props} />;
    };

    const General = () => {
      const {
        register,
        handleSubmit,
        formState: { errors },
      } = ReactHookForm.useFormContext();
      return (
        <form onSubmit={handleSubmit(console.log)}>
          <FormGroup>
            <label>Name</label>
            <input
              autoComplete="off"
              {...register("name", { required: "This is required." })}
            />
            {errors?.name && errors.name.message}
          </FormGroup>
          <FormGroup>
            <label>Description</label>
            <textarea
              {...register("description", { required: "This is required." })}
            />
            {errors?.description && errors.description.message}
          </FormGroup>
        </form>
      );
    };

    const Rules = () => {
      const { control, getValues, setValue } = ReactHookForm.useFormContext();

      const handleUpdate = (rule) => {
        const rules = getValues("rules");
        if (rules.length === 0) {
          setValue("rules", [rule]);
        } else {
          setValue("rules", [{ ...rules[0], ...rule }]);
        }
      };

      const getRuleValue = (rules, index, attr) => {
        if (!rules || rules.length === 0) {
          return "";
        }

        return rules[0][attr] || "";
      };
      return (
        <form>
          <ReactHookForm.Controller
            control={control}
            name="rules"
            render={({ field: { value, name }, fieldState, formState }) => (
              <div className="rules">
                <input
                  value={getRuleValue(value, 0, "name")}
                  onChange={(e) => {
                    const rule = { name: e.target.value };
                    handleUpdate(rule);
                  }}
                />
                <input
                  type="number"
                  value={getRuleValue(value, 0, "value")}
                  onChange={(e) => {
                    const rule = { value: e.target.value };
                    handleUpdate(rule);
                  }}
                />{" "}
                %
              </div>
            )}
          />
        </form>
      );
    };

    function equalTodos(todo1, todo2) {
      return (
        todo1 &&
        todo2 &&
        todo1.name === todo2.name &&
        todo1.description === todo2.description &&
        todo1.rules.length === 1 &&
        todo2.rules.length === 1 &&
        todo1.rules[0].name === todo2.rules[0].name &&
        todo1.rules[0].value === todo2.rules[0].value
      );
    }

    const GlobalActions = ({ todo }) => {
      const mutate = useMutateTodo();

      const handleUpdate = (data, action) => {
        console.log(action, { data, todo });
        mutate.mutate({ ...todo, ...data });
      };

      const formMethods = ReactHookForm.useFormContext();

      const watch = ReactHookForm.useWatch();

      const isSame = equalTodos(todo, watch);
      const isEditing = todo && watch && !isSame;
      return (
        <>
          <button
            type="button"
            disabled={!isEditing}
            onClick={() => handleUpdate(formMethods.getValues(), "save")}
          >
            Save
          </button>
          <button type="button" onClick={() => formMethods.trigger()}>
            Check
          </button>
          <button
            type="button"
            onClick={async () => {
              const isValid = await formMethods.trigger();
              if (isValid) {
                window.alert("✅ form published");
              } else {
                window.alert("❌ form is not valid");
              }
            }}
          >
            Publish
          </button>
        </>
      );
    };

    const Todo = ({ id }) => {
      const { data: todo } = useTodo(id);

      const formMethods = ReactHookForm.useForm(); // { id, name, description, rules: { name, value }[] }
      // instead of const [todoForm, setTodoForm] = React.useState(todo);

      React.useEffect(
        function updateTodoForm() {
          if (todo) {
            formMethods.reset(todo);
          }
        },
        [todo]
      );

      const isGeneralTabError =
        formMethods.formState.errors.name &&
        formMethods.formState.errors.description;

      const isRulesTabError =
        formMethods.formState.errors.rules &&
        formMethods.formState.errors.rules.length > 0;

      return (
        <div className="root">
          <ReactHookForm.FormProvider {...formMethods}>
            <header>
              <GlobalActions todo={todo} />
            </header>
            <sl-tab-group>
              <sl-tab slot="nav" panel="general">
                General
              </sl-tab>
              <sl-tab slot="nav" panel="rules">
                Rules
              </sl-tab>

              <sl-tab-panel name="general">
                <General />
              </sl-tab-panel>
              <sl-tab-panel name="rules">
                <Rules />
              </sl-tab-panel>
            </sl-tab-group>
          </ReactHookForm.FormProvider>
        </div>
      );
    };

    const queryClient = new ReactQuery.QueryClient({
      defaultOptions: { queries: { refetchOnWindowFocus: false } },
    });
    function App() {
      return (
        <ReactQuery.QueryClientProvider client={queryClient}>
          <Todo id={1} />
          <ReactQueryDevtools.ReactQueryDevtools />
        </ReactQuery.QueryClientProvider>
      );
    }

    const root = document.querySelector("[data-js=root]");
    ReactDOM.render(<App />, root);
  </script>
</body>
